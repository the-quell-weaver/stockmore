# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**PrepStock (Stockmore)** is a mobile-first SaaS for emergency/disaster preparedness inventory management. Multi-tenant (org-based), built on Next.js 15 App Router + Supabase (Postgres + Auth). Deployed on Vercel.

Read `AGENTS.md` first — it points to `docs/agent.md`, which contains the full agent workflow, testing requirements, and delivery rules.

## Commands

All commands run from `src/`:

```bash
npm run dev           # Dev server at http://localhost:5566 (Webpack forced — Turbopack unstable on WSL)
npm run build         # Production build
npm run lint          # ESLint
npm run typecheck     # tsc --noEmit
npm run test:unit     # Vitest unit tests (no DB required)
npm run test:integration  # Vitest integration tests (requires local Supabase running)
npm run test:e2e      # Playwright E2E (requires dev server + Supabase running)
npm run test:e2e:smoke    # Single smoke test only
npm run test:ci       # Unit + integration (CI shortcut)
npm run supabase:local-env  # Regenerate src/.env.local from local Supabase
```

E2E in agent/CI context: use `scripts/testing/run-e2e.sh` (handles env prep + server startup).

## Local Dev Setup

```bash
supabase start                     # Start local Supabase stack
supabase db reset                  # Replay all migrations (creates schema)
cd src && npm run supabase:local-env  # Generate src/.env.local
cd src && npm ci && npm run dev
```

Required env vars in `src/.env.local` (auto-generated by the script above):
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

## Architecture

### App Structure (`src/`)

- `app/` — Next.js App Router pages. Server Components by default; `"use client"` only when interaction is needed.
  - `auth/` — Magic link login, sign-up, callback (PKCE exchange), password flows
  - `stock/` — Main protected app (items dashboard, inventory management)
- `components/` — Reusable UI; `ui/` contains shadcn/ui components
- `lib/` — Core logic organized by domain:
  - `lib/supabase/` — `client.ts` (browser/PKCE), `server.ts` (SSR), `proxy.ts` (middleware session)
  - `lib/auth/` — Bootstrap (org/warehouse creation), context derivation, server guards, validation
  - `lib/items/` — Items CRUD service, validation, errors
- `tests/integration/` — DB + RLS integration tests
- `tests/e2e/` — Playwright smoke tests
- `proxy.ts` (root of `src/`) — Next.js middleware guarding `/stock` routes

### Database (`supabase/`)

Migrations are **append-only** in `supabase/migrations/`. Never edit existing migrations; always add new ones.

Key tables: `orgs` → `warehouses` → `org_memberships` → `items`. Every table has `org_id` and RLS enabled.

### Multi-Tenant Security Rules (non-negotiable)

- Every table requires `org_id` and full RLS (select/insert/update/delete policies)
- Server actions/route handlers must derive `org_id` from session+membership — never trust client-supplied `org_id`
- Transactions are append-only; use compensating records to correct, never delete
- Jobs/cron use service role but must scope queries to `org_id`/`warehouse_id`

### Auth Flow

Magic link only (no passwords). PKCE flow: request → email → `/auth/callback?code=...` → server exchanges code → bootstrap org/warehouse via Supabase RPC → session in HttpOnly cookies → middleware guards `/stock`.

## Key Docs (read in this order for a new feature)

1. `docs/prd.md` — product scope, MVP boundaries, global acceptance criteria
2. `docs/data_model.md` — table schemas, indexes, constraints, RLS overview
3. `docs/features/uc_0X_*.md` — the feature spec you're implementing (Acceptance Criteria are authoritative)
4. `docs/testing_guide.md` — how to run tests locally
5. `docs/api_spec.md` — server actions and route handler contracts
6. `docs/security.md` — RLS policies, threat model

## Development Workflow

Per `docs/agent.md`: one PR per feature/fix. Workflow: read spec → write tests first (domain rules, RLS) → minimal implementation → verify against Acceptance Criteria.

Before merging: `test:unit` + `test:integration` + `test:e2e` must all pass. If E2E cannot run, state the reason explicitly.

Doc changes: specs in `docs/` are the single source of truth. Back-fill spec changes before PR merge. Only make minimal incremental changes to docs — do not rewrite entire sections.

## Conventions

- File naming: React components `kebab-case.tsx`, others `kebab-case.ts`
- Variables/functions: `camelCase`; types/interfaces: `PascalCase`; booleans: `isX/hasX/canX`
- Avoid `any`; use `unknown` + runtime validation
- Prefer guard clauses (early returns) over nested conditionals
- Server actions handle auth, validation, DB transactions. Clients only handle interaction and lightweight display validation.
- Error codes: return structured `AppErrorCode` strings from server actions, not raw DB/SDK messages
- Shadcn/ui components via `npx shadcn@latest add <component>` (do not hand-write into `ui/`)
