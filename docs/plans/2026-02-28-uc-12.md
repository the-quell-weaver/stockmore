# UC-12: Print Inventory to PDF — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a "列印" button to `/stock` that calls `window.print()`, outputting a formatted A4 inventory list with item-grouped batches and quantity-box icons.

**Architecture:** Pure client-side: CSS `@media print` (via Tailwind `print:` variants) + `window.print()`. The entire regular UI gets `print:hidden`; a separate `<PrintView>` sibling (screen-hidden, `hidden print:block`) renders the print-only layout. Box rendering is extracted to a tested utility function.

**Tech Stack:** Next.js 15 App Router, React, Tailwind CSS (`print:` variants), Vitest (unit), Playwright (e2e)

**Branch / Worktree:** Implement on `feat/uc11-mode-based-views` in `.worktrees/uc11-mode-views/`.
All `npm run` commands run from `.worktrees/uc11-mode-views/src/`.

---

### Task 1: `renderQuantityBoxes` utility — TDD

**Files:**
- Create: `src/lib/print/quantity-boxes.ts`
- Create: `src/lib/print/quantity-boxes.unit.test.ts`

**Step 1: Write the failing test**

```ts
// src/lib/print/quantity-boxes.unit.test.ts
import { describe, expect, it } from "vitest";
import { renderQuantityBoxes } from "./quantity-boxes";

describe("renderQuantityBoxes", () => {
  it("returns empty string for 0", () => expect(renderQuantityBoxes(0)).toBe(""));
  it("returns empty string for negative", () => expect(renderQuantityBoxes(-3)).toBe(""));
  it("floors non-integers", () => expect(renderQuantityBoxes(1.9)).toBe("□"));
  it("returns 1 box for 1", () => expect(renderQuantityBoxes(1)).toBe("□"));
  it("returns 5 boxes without space for 5", () => expect(renderQuantityBoxes(5)).toBe("□□□□□"));
  it("groups 6 as 5+1 with space", () => expect(renderQuantityBoxes(6)).toBe("□□□□□ □"));
  it("groups 10 as 5+5 with space", () => expect(renderQuantityBoxes(10)).toBe("□□□□□ □□□□□"));
  it("groups 50 as 10 groups of 5", () => {
    const groups = renderQuantityBoxes(50).split(" ");
    expect(groups).toHaveLength(10);
    expect(groups.every((g) => g === "□□□□□")).toBe(true);
  });
});
```

**Step 2: Run to verify FAIL**

```bash
npm run test:unit -- --reporter=verbose 2>&1 | grep -E "(FAIL|PASS|renderQuantity)"
```

Expected: FAIL (module not found)

**Step 3: Implement**

```ts
// src/lib/print/quantity-boxes.ts
export function renderQuantityBoxes(n: number): string {
  const count = Math.floor(n);
  if (count <= 0) return "";
  const groups: string[] = [];
  let i = 0;
  while (i < count) {
    const groupSize = Math.min(5, count - i);
    groups.push("□".repeat(groupSize));
    i += groupSize;
  }
  return groups.join(" ");
}
```

**Step 4: Run to verify PASS**

```bash
npm run test:unit -- --reporter=verbose 2>&1 | grep -E "(FAIL|PASS|renderQuantity)"
```

Expected: all 8 tests PASS

**Step 5: Commit**

```bash
git add src/lib/print/quantity-boxes.ts src/lib/print/quantity-boxes.unit.test.ts
git commit -m "feat(uc12): add renderQuantityBoxes utility with unit tests"
```

---

### Task 2: `PrintView` component

**Files:**
- Create: `src/components/print-view.tsx`

**Step 1: Create the component**

```tsx
// src/components/print-view.tsx
import type { BatchWithRefs } from "@/lib/transactions/service";
import { renderQuantityBoxes } from "@/lib/print/quantity-boxes";

type ItemGroup = {
  itemId: string;
  itemName: string;
  batches: BatchWithRefs[];
};

function groupBatchesByItem(batches: BatchWithRefs[]): ItemGroup[] {
  const map = new Map<string, ItemGroup>();
  for (const batch of batches) {
    const g = map.get(batch.itemId) ?? {
      itemId: batch.itemId,
      itemName: batch.itemName,
      batches: [],
    };
    g.batches.push(batch);
    map.set(batch.itemId, g);
  }
  return [...map.values()];
}

type PrintViewProps = {
  batches: BatchWithRefs[];
  warehouseName: string;
};

export function PrintView({ batches, warehouseName }: PrintViewProps) {
  const groups = groupBatchesByItem(batches);
  const printDate = new Date().toLocaleDateString("zh-TW", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });

  return (
    <div className="hidden print:block p-8 font-sans text-black bg-white">
      {/* Print header */}
      <div className="mb-6 border-b border-gray-300 pb-3">
        <h1 className="text-xl font-bold">庫存清單</h1>
        <p className="text-sm text-gray-600">倉庫：{warehouseName}</p>
        <p className="text-sm text-gray-600">列印日期：{printDate}</p>
      </div>

      {groups.length === 0 ? (
        <p className="text-sm text-gray-500">目前無庫存記錄</p>
      ) : (
        <div className="space-y-4">
          {groups.map((group) => (
            <div key={group.itemId}>
              <h2 className="font-semibold">{group.itemName}</h2>
              <div className="ml-4 mt-1 space-y-1">
                {group.batches.map((batch) => {
                  const meta: string[] = [];
                  if (batch.expiryDate) meta.push(`到期：${batch.expiryDate}`);
                  if (batch.storageLocationName) meta.push(batch.storageLocationName);
                  if (batch.tagName) meta.push(batch.tagName);
                  return (
                    <div key={batch.id} className="flex items-baseline gap-2 text-sm">
                      <span className="font-mono tracking-widest">
                        {renderQuantityBoxes(batch.quantity)}
                      </span>
                      {meta.length > 0 && (
                        <span className="text-gray-600 text-xs">（{meta.join(" · ")}）</span>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

**Step 2: Typecheck**

```bash
npm run typecheck 2>&1 | tail -20
```

Expected: no errors

**Step 3: Commit**

```bash
git add src/components/print-view.tsx
git commit -m "feat(uc12): add PrintView component for print layout"
```

---

### Task 3: Wire print button + PrintView into stock-page-client.tsx; add @page CSS

**Files:**
- Modify: `src/components/stock-page-client.tsx`
- Modify: `src/app/globals.css`

**Step 1: Add `@page` rule to `globals.css`**

Append after the closing `}` of the `@layer base` block (the last block in the file):

```css
@media print {
  @page {
    size: A4 portrait;
    margin: 1.5cm;
  }
}
```

**Step 2: Modify `stock-page-client.tsx`**

a) Add import after the existing imports:
```tsx
import { PrintView } from "@/components/print-view";
```

b) Add `print:hidden` to the outer wrapper div:
```tsx
// FROM:
<div className="mx-auto w-full max-w-xl p-4 md:p-6">
// TO:
<div className="mx-auto w-full max-w-xl p-4 md:p-6 print:hidden">
```

c) In the header, replace the standalone `<HamburgerMenu>` with a flex wrapper that includes the print button:
```tsx
// FROM:
<HamburgerMenu
  onOpenLocations={() => setLocationsOpen(true)}
  onOpenTags={() => setTagsOpen(true)}
/>
// TO:
<div className="flex shrink-0 items-center gap-1">
  <button
    onClick={() => window.print()}
    className="inline-flex h-8 items-center rounded border px-3 text-xs"
  >
    列印
  </button>
  <HamburgerMenu
    onOpenLocations={() => setLocationsOpen(true)}
    onOpenTags={() => setTagsOpen(true)}
  />
</div>
```

d) Wrap the return in a React fragment and add `<PrintView>` as a sibling after the main div:
```tsx
// FROM:
return (
  <div className="mx-auto w-full max-w-xl p-4 md:p-6 print:hidden">
    ...
  </div>
);
// TO:
return (
  <>
    <div className="mx-auto w-full max-w-xl p-4 md:p-6 print:hidden">
      ...
    </div>
    <PrintView batches={batches} warehouseName={warehouseName} />
  </>
);
```

**Step 3: Typecheck + lint + unit tests**

```bash
npm run typecheck 2>&1 | tail -10
npm run lint 2>&1 | tail -10
npm run test:unit 2>&1 | tail -5
```

Expected: no errors, all unit tests pass (148+ tests)

**Step 4: Commit**

```bash
git add src/components/stock-page-client.tsx src/app/globals.css
git commit -m "feat(uc12): add print button and PrintView to stock page"
```

---

### Task 4: E2E test for print button

**Files:**
- Create: `src/e2e/uc12-print-inventory.spec.ts`

**Step 1: Write the test**

```ts
// src/e2e/uc12-print-inventory.spec.ts
import { expect, test } from "@playwright/test";

test.describe("UC-12: print inventory", () => {
  test("print button is visible on /stock", async ({ page }) => {
    await page.goto("/stock");
    await expect(page.getByRole("button", { name: "列印" })).toBeVisible();
  });

  test("clicking print button calls window.print", async ({ page }) => {
    await page.addInitScript(() => {
      (window as unknown as Record<string, unknown>).__printCalled = false;
      window.print = () => {
        (window as unknown as Record<string, unknown>).__printCalled = true;
      };
    });
    await page.goto("/stock");
    await page.getByRole("button", { name: "列印" }).click();
    const called = await page.evaluate(
      () => (window as unknown as Record<string, unknown>).__printCalled,
    );
    expect(called).toBe(true);
  });
});
```

**Step 2: Commit**

```bash
git add src/e2e/uc12-print-inventory.spec.ts
git commit -m "test(uc12): e2e tests for print button visibility and window.print call"
```

---

### Verification

**Unit tests** (no Supabase needed):
```bash
npm run test:unit 2>&1 | tail -5
```
Expected: all pass (includes 8 new renderQuantityBoxes tests)

**Typecheck + lint**:
```bash
npm run typecheck && npm run lint
```
Expected: no errors

**Integration tests** (requires local Supabase):
```bash
npm run test:integration 2>&1 | tail -5
```
Expected: all pass (no new integration tests for this feature)

**Manual print preview** (requires `npm run dev`):
1. Open http://localhost:5566/stock
2. Confirm "列印" button visible in header (next to hamburger menu)
3. Click "列印" — browser print dialog opens
4. In print preview: regular UI hidden, print layout shows warehouse + date header, items grouped with quantity boxes, batch meta
5. Empty state: clear all stock and confirm print shows "目前無庫存記錄" (AC5)
6. Check A4 portrait sizing in print preview (AC6)
