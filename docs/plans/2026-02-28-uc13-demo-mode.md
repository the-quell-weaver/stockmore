# UC-13 Demo Mode Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Allow visitors to try PrepStock via `/demo` without registering — anonymous sign-in → bootstrap → seed fixture data → redirect to `/stock`.

**Architecture:** A server-side Route Handler at `src/app/demo/route.ts` creates an anonymous Supabase session using `createRouteHandlerClient` (same pattern as `auth/callback/route.ts`), runs the existing `bootstrapDefaultOrgAndWarehouse` RPC, seeds 6 items + 12 batches from a TypeScript fixture via the existing `createItem`/`createInboundBatch` service functions, then redirects to `/stock?mode=consume`. No `isDemo`/`isAnonymous` checks anywhere in app code — anonymous users follow the identical code path as regular users, with their own fully RLS-isolated org.

**Tech Stack:** Next.js 15 Route Handler, `createRouteHandlerClient` from `src/lib/supabase/server.ts`, `bootstrapDefaultOrgAndWarehouse` from `src/lib/auth/bootstrap.ts`, `createItem`/`listItems` from `src/lib/items/service.ts`, `createInboundBatch` from `src/lib/transactions/service.ts`, Vitest (unit + integration), Playwright (E2E).

---

### Task 1: Enable Anonymous Auth in Local Supabase Config

**Files:**
- Modify: `supabase/config.toml`

**Step 1: Add anonymous_users section to config.toml**

After the `[auth.email]` block, add:
```toml
[auth.anonymous_users]
enabled = true
```

**Step 2: Restart local Supabase to apply the config**
```bash
supabase stop && supabase start
```
Expected: Supabase restarts; no migration errors.

**Step 3: Commit**
```bash
git add supabase/config.toml
git commit -m "config(uc13): enable anonymous auth in local Supabase"
```

> **Manual steps for other environments (not automated):**
> Preview + production Supabase: Dashboard → Authentication → Providers → Anonymous → Enable.
> Set auto-cleanup for anonymous users to 72 hours in Dashboard → Authentication → Users settings.

---

### Task 2: Create Demo Error Types and Seed Fixture

**Files:**
- Create: `src/lib/demo/errors.ts`
- Create: `src/lib/demo/seed-fixture.ts`

**Step 1: Create errors.ts**

```typescript
// src/lib/demo/errors.ts
export const DEMO_ERROR_CODES = {
  SIGN_IN_FAILED: "SIGN_IN_FAILED",
  BOOTSTRAP_FAILED: "BOOTSTRAP_FAILED",
  SEED_FAILED: "SEED_FAILED",
} as const;

export type DemoErrorCode = (typeof DEMO_ERROR_CODES)[keyof typeof DEMO_ERROR_CODES];
```

**Step 2: Create seed-fixture.ts**

```typescript
// src/lib/demo/seed-fixture.ts

export type SeedItem = {
  /** Internal reference key used by SeedBatch.itemRef */
  ref: string;
  name: string;
  unit: string;
  minStock: number;
  note?: string;
};

export type SeedBatch = {
  /** Matches SeedItem.ref */
  itemRef: string;
  quantity: number;
  expiryDate: string | null; // YYYY-MM-DD or null
};

export const SEED_ITEMS: readonly SeedItem[] = [
  { ref: "water",     name: "礦泉水",   unit: "瓶", minStock: 36 },
  { ref: "dryfood",   name: "即食乾糧", unit: "包", minStock: 20 },
  { ref: "firstaid",  name: "急救包",   unit: "個", minStock: 2  },
  { ref: "batteries", name: "乾電池",   unit: "顆", minStock: 20 },
  { ref: "masks",     name: "口罩",     unit: "片", minStock: 50 },
  { ref: "canned",    name: "罐頭食品", unit: "罐", minStock: 24 },
] as const;

// 12 batches: 2 per item, mix of future expiry / no expiry / expired
export const SEED_BATCHES: readonly SeedBatch[] = [
  // 礦泉水
  { itemRef: "water",     quantity: 24, expiryDate: "2027-12-31" },
  { itemRef: "water",     quantity: 12, expiryDate: null },
  // 即食乾糧 (one expired to demo near-expiry state)
  { itemRef: "dryfood",   quantity: 15, expiryDate: "2027-06-30" },
  { itemRef: "dryfood",   quantity: 5,  expiryDate: "2025-01-01" },
  // 急救包
  { itemRef: "firstaid",  quantity: 2,  expiryDate: "2028-12-31" },
  { itemRef: "firstaid",  quantity: 1,  expiryDate: "2026-06-30" },
  // 乾電池
  { itemRef: "batteries", quantity: 16, expiryDate: "2030-12-31" },
  { itemRef: "batteries", quantity: 8,  expiryDate: null },
  // 口罩 (one expired)
  { itemRef: "masks",     quantity: 50, expiryDate: "2027-03-31" },
  { itemRef: "masks",     quantity: 20, expiryDate: "2025-06-01" },
  // 罐頭食品
  { itemRef: "canned",    quantity: 18, expiryDate: "2028-06-30" },
  { itemRef: "canned",    quantity: 6,  expiryDate: null },
] as const;
```

**Step 3: Run typecheck to verify no errors**
```bash
cd src && npm run typecheck
```
Expected: no errors

**Step 4: Commit**
```bash
git add src/lib/demo/errors.ts src/lib/demo/seed-fixture.ts
git commit -m "feat(uc13): add demo error codes and seed fixture"
```

---

### Task 3: Implement seedDemoData with Unit Tests (TDD)

**Files:**
- Create: `src/lib/demo/seed-demo-data.unit.test.ts` (write first)
- Create: `src/lib/demo/seed-demo-data.ts`

**Step 1: Write failing unit tests**

```typescript
// src/lib/demo/seed-demo-data.unit.test.ts
import { afterEach, describe, expect, it, vi } from "vitest";
import type { SupabaseClient } from "@supabase/supabase-js";
import { SEED_BATCHES, SEED_ITEMS } from "./seed-fixture";

vi.mock("@/lib/items/service", () => ({
  listItems: vi.fn(),
  createItem: vi.fn(),
}));
vi.mock("@/lib/transactions/service", () => ({
  createInboundBatch: vi.fn(),
}));

import { createItem, listItems } from "@/lib/items/service";
import { createInboundBatch } from "@/lib/transactions/service";
import { seedDemoData } from "./seed-demo-data";

const fakeSupabase = () => ({} as unknown as SupabaseClient);

const makeItem = (name: string) => ({
  id: `id-${name}`,
  orgId: "org-1",
  name,
  unit: "個",
  minStock: 0,
  defaultTagIds: [],
  note: null,
  isDeleted: false,
  targetQuantity: null,
  createdAt: "",
  updatedAt: "",
});

afterEach(() => vi.clearAllMocks());

describe("seedDemoData", () => {
  it("is idempotent: returns ok:true without seeding if items already exist", async () => {
    vi.mocked(listItems).mockResolvedValue([makeItem("水")]);

    const result = await seedDemoData(fakeSupabase());

    expect(result).toEqual({ ok: true });
    expect(createItem).not.toHaveBeenCalled();
    expect(createInboundBatch).not.toHaveBeenCalled();
  });

  it("creates all items and batches from fixture when org is empty", async () => {
    vi.mocked(listItems).mockResolvedValue([]);
    vi.mocked(createItem).mockImplementation(async (_, input) =>
      makeItem(input.name),
    );
    vi.mocked(createInboundBatch).mockResolvedValue({
      batchId: "b-1",
      transactionId: "tx-1",
      batchQuantity: 10,
    });

    const result = await seedDemoData(fakeSupabase());

    expect(result).toEqual({ ok: true });
    expect(createItem).toHaveBeenCalledTimes(SEED_ITEMS.length);
    expect(createInboundBatch).toHaveBeenCalledTimes(SEED_BATCHES.length);
  });

  it("returns { ok: false, error: SEED_FAILED } if createItem throws", async () => {
    vi.mocked(listItems).mockResolvedValue([]);
    vi.mocked(createItem).mockRejectedValue(new Error("DB error"));

    const result = await seedDemoData(fakeSupabase());

    expect(result).toEqual({ ok: false, error: "SEED_FAILED" });
  });

  it("returns { ok: false, error: SEED_FAILED } if createInboundBatch throws", async () => {
    vi.mocked(listItems).mockResolvedValue([]);
    vi.mocked(createItem).mockImplementation(async (_, input) =>
      makeItem(input.name),
    );
    vi.mocked(createInboundBatch).mockRejectedValue(new Error("Batch error"));

    const result = await seedDemoData(fakeSupabase());

    expect(result).toEqual({ ok: false, error: "SEED_FAILED" });
  });
});
```

**Step 2: Run tests to confirm they fail**
```bash
cd src && npm run test:unit -- seed-demo-data
```
Expected: FAIL — module `seed-demo-data` not found.

**Step 3: Implement seedDemoData**

```typescript
// src/lib/demo/seed-demo-data.ts
import type { SupabaseClient } from "@supabase/supabase-js";
import { createItem, listItems } from "@/lib/items/service";
import { createInboundBatch } from "@/lib/transactions/service";
import { DEMO_ERROR_CODES } from "./errors";
import { SEED_BATCHES, SEED_ITEMS } from "./seed-fixture";

export type SeedResult = { ok: true } | { ok: false; error: string };

export async function seedDemoData(supabase: SupabaseClient): Promise<SeedResult> {
  try {
    // AC6 / R2: idempotency — skip if org already has items
    const existing = await listItems(supabase);
    if (existing.length > 0) {
      return { ok: true };
    }

    // Create items, build ref → id map for batch creation
    const itemIdByRef = new Map<string, string>();
    for (const seedItem of SEED_ITEMS) {
      const created = await createItem(supabase, {
        name: seedItem.name,
        unit: seedItem.unit,
        minStock: seedItem.minStock,
        note: seedItem.note,
      });
      itemIdByRef.set(seedItem.ref, created.id);
    }

    // Create batches
    for (const batch of SEED_BATCHES) {
      const itemId = itemIdByRef.get(batch.itemRef);
      if (!itemId) continue;
      await createInboundBatch(supabase, {
        itemId,
        quantity: batch.quantity,
        expiryDate: batch.expiryDate ?? null,
      });
    }

    return { ok: true };
  } catch {
    return { ok: false, error: DEMO_ERROR_CODES.SEED_FAILED };
  }
}
```

**Step 4: Run tests to confirm they pass**
```bash
cd src && npm run test:unit -- seed-demo-data
```
Expected: PASS (4 tests)

**Step 5: Commit**
```bash
git add src/lib/demo/seed-demo-data.unit.test.ts src/lib/demo/seed-demo-data.ts
git commit -m "feat(uc13): implement seedDemoData with idempotency guard and unit tests"
```

---

### Task 4: Create /demo Route Handler + Error Page

**Files:**
- Create: `src/app/demo/route.ts`
- Create: `src/app/demo/error/page.tsx`

**Step 1: Create the /demo route handler**

The flow: check existing session → sign out old anon session if any → anonymous sign-in → bootstrap → seed → redirect to `/stock?mode=consume`. Non-anonymous authenticated users are immediately redirected to `/stock` (AC5).

```typescript
// src/app/demo/route.ts
import { type NextRequest, NextResponse } from "next/server";
import { bootstrapDefaultOrgAndWarehouse } from "@/lib/auth/bootstrap";
import { createRouteHandlerClient } from "@/lib/supabase/server";
import { seedDemoData } from "@/lib/demo/seed-demo-data";

export async function GET(request: NextRequest) {
  const { supabase, finalizeResponse } = createRouteHandlerClient(request);

  // AC5: Redirect authenticated non-anonymous users to /stock (preserve session)
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (user && !user.is_anonymous) {
    return finalizeResponse(
      NextResponse.redirect(new URL("/stock", request.url)),
    );
  }

  // R1: Always create a fresh anonymous session — sign out any existing anon session
  if (user?.is_anonymous) {
    await supabase.auth.signOut();
  }

  // Step 1: Anonymous sign-in
  const { error: signInError } = await supabase.auth.signInAnonymously();
  if (signInError) {
    return finalizeResponse(
      NextResponse.redirect(
        new URL("/demo/error?error=SIGN_IN_FAILED", request.url),
      ),
    );
  }

  // Step 2: Bootstrap org + default warehouse (existing RPC)
  try {
    await bootstrapDefaultOrgAndWarehouse(supabase);
  } catch {
    return finalizeResponse(
      NextResponse.redirect(
        new URL("/demo/error?error=BOOTSTRAP_FAILED", request.url),
      ),
    );
  }

  // Step 3: Seed demo data (idempotent)
  const seedResult = await seedDemoData(supabase);
  if (!seedResult.ok) {
    return finalizeResponse(
      NextResponse.redirect(
        new URL(`/demo/error?error=${seedResult.error}`, request.url),
      ),
    );
  }

  // Step 4: Redirect to stock
  return finalizeResponse(
    NextResponse.redirect(new URL("/stock?mode=consume", request.url)),
  );
}
```

**Step 2: Create demo error page**

```typescript
// src/app/demo/error/page.tsx
import Link from "next/link";
import { Button } from "@/components/ui/button";

interface Props {
  searchParams: Promise<{ error?: string }>;
}

export default async function DemoErrorPage({ searchParams }: Props) {
  const { error } = await searchParams;
  const message =
    error === "SIGN_IN_FAILED"
      ? "無法建立試用 session，請稍後再試。"
      : error === "BOOTSTRAP_FAILED"
        ? "無法初始化試用資料，請稍後再試。"
        : "試用模式啟動失敗，請稍後再試。";

  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6">
      <div className="w-full max-w-sm space-y-4 text-center">
        <h1 className="text-xl font-semibold">試用模式發生錯誤</h1>
        <p className="text-sm text-muted-foreground">{message}</p>
        <div className="flex flex-col gap-2">
          <Button asChild>
            <Link href="/demo">重試</Link>
          </Button>
          <Button asChild variant="outline">
            <Link href="/auth/sign-up">前往註冊</Link>
          </Button>
        </div>
      </div>
    </div>
  );
}
```

**Step 3: Run typecheck and lint**
```bash
cd src && npm run typecheck && npm run lint
```
Expected: no errors

**Step 4: Manual smoke test**

Start dev server + local Supabase. Open incognito browser, visit `http://localhost:5566/demo`. Should redirect to `/stock?mode=consume` and show seeded inventory items.

**Step 5: Commit**
```bash
git add src/app/demo/route.ts src/app/demo/error/page.tsx
git commit -m "feat(uc13): add /demo route handler and error page"
```

---

### Task 5: Add "Try Demo" CTA to Landing Page and Login Page

**Files:**
- Modify: `src/app/page.tsx`
- Modify: `src/app/auth/login/page.tsx`

**Step 1: Update landing page** (`src/app/page.tsx`)

Replace the single `<Button asChild>` block (line 32–34) with two buttons:

```tsx
<div className="flex flex-wrap gap-3">
  <Button asChild>
    <Link href="/stock">前往庫存</Link>
  </Button>
  <Button asChild variant="outline">
    <Link href="/demo">試用 Demo</Link>
  </Button>
</div>
```

**Step 2: Update login page** (`src/app/auth/login/page.tsx`)

Add a demo link below the form component:

```tsx
import Link from "next/link";
import { LoginPasswordFormClient } from "@/components/login-password-form-client";

export default function Page() {
  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
      <div className="w-full max-w-sm space-y-4">
        <LoginPasswordFormClient />
        <p className="text-center text-sm text-muted-foreground">
          想先試試看？{" "}
          <Link href="/demo" className="underline underline-offset-4">
            試用 Demo
          </Link>
        </p>
      </div>
    </div>
  );
}
```

**Step 3: Run lint + typecheck**
```bash
cd src && npm run lint && npm run typecheck
```
Expected: no errors

**Step 4: Commit**
```bash
git add src/app/page.tsx src/app/auth/login/page.tsx
git commit -m "feat(uc13): add Try Demo CTA to landing page and login page"
```

---

### Task 6: Integration Tests for Demo Seed Flow

**Files:**
- Create: `src/tests/integration/demo/demo.integration.test.ts`

These tests connect to local Supabase (requires `supabase start` with anonymous auth enabled from Task 1).

**Step 1: Write integration tests**

```typescript
// src/tests/integration/demo/demo.integration.test.ts
import { existsSync, readFileSync } from "node:fs";
import path from "node:path";
import { createClient } from "@supabase/supabase-js";
import { describe, expect, it } from "vitest";
import { bootstrapDefaultOrgAndWarehouse } from "@/lib/auth/bootstrap";
import { seedDemoData } from "@/lib/demo/seed-demo-data";
import { SEED_ITEMS } from "@/lib/demo/seed-fixture";
import { listItems } from "@/lib/items/service";

// ── ENV LOADING (same pattern as other integration tests) ──────────
function loadEnvFiles() {
  const candidatePaths = [
    path.resolve(process.cwd(), ".env.local"),
    path.resolve(process.cwd(), ".env"),
  ];
  for (const envPath of candidatePaths) {
    if (!existsSync(envPath)) continue;
    const content = readFileSync(envPath, "utf8");
    for (const rawLine of content.split(/\r?\n/)) {
      const line = rawLine.trim();
      if (!line || line.startsWith("#")) continue;
      const eqIndex = line.indexOf("=");
      if (eqIndex <= 0) continue;
      const key = line.slice(0, eqIndex).trim();
      let value = line.slice(eqIndex + 1).trim();
      if (
        (value.startsWith('"') && value.endsWith('"')) ||
        (value.startsWith("'") && value.endsWith("'"))
      ) {
        value = value.slice(1, -1);
      }
      if (!process.env[key]) process.env[key] = value;
    }
  }
}

function requiredEnv(key: string): string {
  const val = process.env[key];
  if (!val) throw new Error(`Missing required env var: ${key}`);
  return val;
}

loadEnvFiles();

const supabaseUrl = requiredEnv("NEXT_PUBLIC_SUPABASE_URL");
const serviceRoleKey = requiredEnv("SUPABASE_SERVICE_ROLE_KEY");
const anonKey =
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ??
  requiredEnv("NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY");

const adminClient = createClient(supabaseUrl, serviceRoleKey, {
  auth: { autoRefreshToken: false, persistSession: false },
});

async function signInAnonymously() {
  const client = createClient(supabaseUrl, anonKey, {
    auth: { autoRefreshToken: false, persistSession: false },
  });
  const { data, error } = await client.auth.signInAnonymously();
  if (error || !data.session) throw error ?? new Error("Anonymous sign-in failed");

  return {
    client: createClient(supabaseUrl, anonKey, {
      auth: { autoRefreshToken: false, persistSession: false },
      global: {
        headers: { Authorization: `Bearer ${data.session.access_token}` },
      },
    }),
    userId: data.user!.id,
  };
}

async function cleanupAnonUser(userId: string) {
  const { data: memberships } = await adminClient
    .from("org_memberships")
    .select("org_id")
    .eq("user_id", userId);
  const orgIds = (memberships ?? []).map((r) => r.org_id).filter(Boolean);
  if (orgIds.length > 0) {
    await adminClient.from("orgs").delete().in("id", orgIds);
  }
  await adminClient.auth.admin.deleteUser(userId);
}

describe("seedDemoData integration (UC-13)", () => {
  it("seeds items and batches from fixture after anonymous bootstrap", async () => {
    const { client, userId } = await signInAnonymously();
    try {
      await bootstrapDefaultOrgAndWarehouse(client);
      const result = await seedDemoData(client);

      expect(result).toEqual({ ok: true });

      const items = await listItems(client);
      expect(items).toHaveLength(SEED_ITEMS.length);
      expect(items.map((i) => i.name)).toEqual(
        expect.arrayContaining(SEED_ITEMS.map((s) => s.name)),
      );
    } finally {
      await cleanupAnonUser(userId);
    }
  });

  it("is idempotent: calling seedDemoData twice does not create duplicate items", async () => {
    const { client, userId } = await signInAnonymously();
    try {
      await bootstrapDefaultOrgAndWarehouse(client);
      await seedDemoData(client);
      await seedDemoData(client); // second call must be a no-op

      const items = await listItems(client);
      expect(items).toHaveLength(SEED_ITEMS.length);
    } finally {
      await cleanupAnonUser(userId);
    }
  });

  it("RLS: demo org data is invisible to other users (cross-org isolation)", async () => {
    const { client: clientA, userId: userIdA } = await signInAnonymously();
    const { client: clientB, userId: userIdB } = await signInAnonymously();
    try {
      const { orgId: orgIdA } =
        await bootstrapDefaultOrgAndWarehouse(clientA);
      await bootstrapDefaultOrgAndWarehouse(clientB);
      await seedDemoData(clientA);

      // User B has their own empty org; should see zero items
      const itemsB = await listItems(clientB);
      expect(itemsB).toHaveLength(0);

      // Direct RLS check: User B cannot read User A's org data
      const crossRead = await clientB
        .from("items")
        .select("id")
        .eq("org_id", orgIdA);
      expect(crossRead.error).toBeNull();
      expect(crossRead.data).toEqual([]);
    } finally {
      await cleanupAnonUser(userIdA);
      await cleanupAnonUser(userIdB);
    }
  });
});
```

**Step 2: Run integration tests**
```bash
cd src && npm run test:integration -- demo
```
Expected: PASS (3 tests). If "Anonymous sign-in failed", confirm Task 1 was applied and Supabase restarted.

**Step 3: Commit**
```bash
git add src/tests/integration/demo/demo.integration.test.ts
git commit -m "test(uc13): integration tests for seedDemoData and RLS isolation"
```

---

### Task 7: E2E Tests

**Files:**
- Create: `src/e2e/demo.spec.ts`

**Step 1: Write E2E tests**

```typescript
// src/e2e/demo.spec.ts
import { expect, test } from "@playwright/test";

// AC1 + AC2: unauthenticated visitor gets redirected and sees seeded stock data
test("unauthenticated visitor: /demo redirects to /stock with seed data visible", async ({
  browser,
}) => {
  const baseURL =
    process.env.PLAYWRIGHT_BASE_URL ?? "http://localhost:5566";
  // Create a fresh context with no auth (override the global storageState)
  const context = await browser.newContext({ baseURL });
  const page = await context.newPage();

  await page.goto("/demo");

  await expect(page).toHaveURL(/\/stock/, { timeout: 20_000 });

  // At least one seeded item name should be visible
  await expect(
    page.getByText("礦泉水").or(page.getByText("即食乾糧")),
  ).toBeVisible({ timeout: 10_000 });

  await context.close();
});

// AC5: authenticated (non-anonymous) user visiting /demo is redirected to /stock
// Uses the default pre-authenticated storageState from global-setup
test("authenticated user: /demo redirects to /stock without clearing their session", async ({
  page,
}) => {
  await page.goto("/demo");
  await expect(page).toHaveURL(/\/stock/, { timeout: 10_000 });
  // Verify they weren't signed out (stock page is accessible)
  await expect(page.getByRole("heading", { name: /stock/i })).toBeVisible({
    timeout: 5_000,
  });
});
```

**Step 2: Run E2E tests**
```bash
scripts/testing/run-e2e.sh -- demo.spec
```
Expected: PASS (2 tests)

**Step 3: Commit**
```bash
git add src/e2e/demo.spec.ts
git commit -m "test(uc13): e2e tests for /demo redirect and session handling (AC1, AC2, AC5)"
```

---

### Task 8: Export Script (Dev Utility)

**Files:**
- Create: `scripts/export-demo-seed.ts`

This is a developer utility to update the seed fixture from a live org. It requires `ts-node` and writes the fixture to stdout.

**Step 1: Create the export script**

```typescript
// scripts/export-demo-seed.ts
// Usage: npx ts-node scripts/export-demo-seed.ts <org_id>
// Reads NEXT_PUBLIC_SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY from src/.env.local

import { createClient } from "@supabase/supabase-js";
import * as fs from "fs";
import * as path from "path";

const orgId = process.argv[2];
if (!orgId) {
  console.error("Usage: npx ts-node scripts/export-demo-seed.ts <org_id>");
  process.exit(1);
}

// Load env from src/.env.local
const envPath = path.resolve(__dirname, "../src/.env.local");
if (fs.existsSync(envPath)) {
  const content = fs.readFileSync(envPath, "utf8");
  for (const line of content.split(/\r?\n/)) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith("#")) continue;
    const eqIdx = trimmed.indexOf("=");
    if (eqIdx <= 0) continue;
    const key = trimmed.slice(0, eqIdx).trim();
    const val = trimmed
      .slice(eqIdx + 1)
      .trim()
      .replace(/^["']|["']$/g, "");
    if (!process.env[key]) process.env[key] = val;
  }
}

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !serviceRoleKey) {
  console.error(
    "Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY",
  );
  process.exit(1);
}

const admin = createClient(supabaseUrl, serviceRoleKey, {
  auth: { autoRefreshToken: false, persistSession: false },
});

const toRef = (name: string) =>
  name
    .toLowerCase()
    .replace(/[^a-z0-9]/g, "_")
    .replace(/_+/g, "_")
    .replace(/^_|_$/g, "");

async function main() {
  const { data: items, error: itemsErr } = await admin
    .from("items")
    .select("id, name, unit, min_stock, note")
    .eq("org_id", orgId)
    .eq("is_deleted", false)
    .order("name");
  if (itemsErr) {
    console.error("Failed to fetch items:", itemsErr);
    process.exit(1);
  }

  const { data: batches, error: batchesErr } = await admin
    .from("batches")
    .select("item_id, quantity, expiry_date")
    .eq("org_id", orgId)
    .gt("quantity", 0)
    .order("item_id");
  if (batchesErr) {
    console.error("Failed to fetch batches:", batchesErr);
    process.exit(1);
  }

  const itemRefById = new Map(
    (items ?? []).map((i) => [i.id, toRef(i.name)]),
  );

  const seedItems = (items ?? []).map((i) => ({
    ref: toRef(i.name),
    name: i.name,
    unit: i.unit,
    minStock: Number(i.min_stock),
    ...(i.note ? { note: i.note } : {}),
  }));

  const seedBatches = (batches ?? []).map((b) => ({
    itemRef: itemRefById.get(b.item_id) ?? "unknown",
    quantity: Number(b.quantity),
    expiryDate: b.expiry_date ?? null,
  }));

  console.log(
    "// Auto-generated by scripts/export-demo-seed.ts — do not edit manually",
  );
  console.log(
    "// Run: npx ts-node scripts/export-demo-seed.ts <org_id> > src/lib/demo/seed-fixture.ts",
  );
  console.log("");
  console.log(
    "export const SEED_ITEMS = " +
      JSON.stringify(seedItems, null, 2) +
      " as const;",
  );
  console.log("");
  console.log(
    "export const SEED_BATCHES = " +
      JSON.stringify(seedBatches, null, 2) +
      " as const;",
  );
}

main().catch(console.error);
```

**Step 2: Commit**
```bash
git add scripts/export-demo-seed.ts
git commit -m "feat(uc13): add dev export script for updating demo seed fixture"
```

---

### Task 9: Update docs/api_spec.md

**Files:**
- Modify: `docs/api_spec.md`

**Step 1: Add UC-13 section to api_spec.md**

Append to the end of `docs/api_spec.md`:

```markdown
## UC-13: Demo Mode

### GET /demo

Initiates an anonymous demo session. Pure server-side — no request body.

| Field | Value |
|---|---|
| Auth | None required (anonymous sign-in performed server-side) |
| Flow | `signInAnonymously` → `bootstrap_default_org_and_warehouse` RPC → `seedDemoData` → redirect `/stock?mode=consume` |
| AC5 | If caller has non-anonymous session: redirect to `/stock` (session unchanged) |
| Error | Redirect to `/demo/error?error=<SIGN_IN_FAILED\|BOOTSTRAP_FAILED\|SEED_FAILED>` |

### seedDemoData(supabase) → SeedResult

Inserts seed fixture data for the authenticated user's org.

- **File**: `src/lib/demo/seed-demo-data.ts`
- **Auth**: Derived from Supabase session (never trusts client-supplied `org_id`)
- **Idempotency**: Returns `{ ok: true }` immediately if `listItems` finds any existing items
- **Data source**: `src/lib/demo/seed-fixture.ts` — 6 items (防災物資), 12 batches
- **Failure**: Any exception returns `{ ok: false, error: "SEED_FAILED" }`
- **Response**: `{ ok: true }` | `{ ok: false; error: string }`
```

**Step 2: Commit**
```bash
git add docs/api_spec.md
git commit -m "docs(uc13): add /demo route and seedDemoData to api_spec"
```

---

## Verification

Run the full test suite after all tasks:

```bash
cd src
npm run test:unit         # Unit: seed-demo-data (4 tests)
npm run test:integration  # Integration: demo (3 tests) + all existing tests
scripts/testing/run-e2e.sh  # E2E: demo.spec (2 tests) + all existing tests
```

**Manual acceptance criteria verification:**

| AC | Test |
|----|------|
| AC1: Visitor visits `/demo`, no login, auto-redirect to `/stock` | E2E test #1 + manual incognito |
| AC2: `/stock` shows seeded data, all features work | Manual verification |
| AC3: Demo org isolated from other orgs | Integration test #3 (RLS) |
| AC4: No `isDemo`/`isAnonymous` in app code | `grep -r "isDemo\|isAnonymous" src/` should return nothing |
| AC5: Authenticated user at `/demo` → `/stock` (no sign-out) | E2E test #2 |
| AC6: `seedDemoData` twice → no duplicates | Unit test #1 + Integration test #2 |
| AC7: Works in preview/production (after enabling anon auth in Dashboard) | Deployment checklist |

**Manual smoke test steps:**
1. Open incognito → visit `/demo` → should land on `/stock?mode=consume` with 6 items visible
2. Perform a consume action → verify it works identically to regular users
3. Close incognito → re-open → visit `/demo` again → fresh session with fresh data
4. Login as real user → visit `/demo` → redirected to `/stock`, session preserved
5. Visit `/demo/error?error=SEED_FAILED` → friendly error page with retry + signup links

**Deployment checklist (not automated):**
- [ ] Enable anonymous sign-in in Supabase Dashboard (preview env)
- [ ] Enable anonymous sign-in in Supabase Dashboard (production env)
- [ ] Set anonymous user auto-cleanup to 72 hours in Dashboard (both envs)
