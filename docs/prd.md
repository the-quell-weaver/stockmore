# PrepStock（防災物資庫存管理）PRD（Global Overview）

> 本文件維持「全局概覽」角色：描述產品目標、MVP 範圍、用例與全局驗收。每個功能細節應拆到 `docs/features/*.md`。

## 1. 產品背景與問題定義

* 防災物資需要長期維護（採購、存放、到期、補貨），但多數人缺乏簡單易用的管理工具。
* 在緊急情境下，電力/網路可能中斷，因此需要「資料可攜 / 可轉移」的備援策略（未來支援自架與純本地模式；MVP 先以雲端網頁服務提供）。
* 產品要降低推廣阻力：使用者能快速建立庫存並在手機上順手維護，同時在電腦上也能順利操作。

## 2. 目標（Goals）

### 2.1 三種操作模式（Architecture Goal）

系統架構需能支援使用者以三種方式操作（MVP 先完成模式 A；B/C 為後續功能，但架構設計需保留可行路徑）：

A) **雲端網頁服務（Hosted Web App）**

* 以 Next.js + Supabase 的多租戶架構提供服務。

B) **自架後端（Self-hosted Backend）— 後續功能**

* 使用者可在自有環境部署後端（可仿照 grocy 的部署與連結方式）。
* 必須能從雲端環境**匯出資料並搬遷**到自架環境（含必要的 schema / migrations / RLS 等價能力或替代方案）。

C) **純本地工作（Local-first / On-device）— 後續功能**

* 使用者可在自己的電腦或手機上運行（想像對前端來說仍是「連到一個本地運作的後端」）。
* 透過**匯出/匯入資料庫**進行資料轉移。
* 困難點在於後端邏輯需能被搬移到使用者裝置上執行（或以等價方式重用同一套 domain 邏輯）。

> 設計要求（高層次）：Domain 邏輯與資料模型需以可攜、可重播（event/transaction append-only）為主，並避免把關鍵規則散落在雲端特定服務中，讓未來 B/C 可用最小差異完成。

### 2.2 產品能力目標（Product Goals）

* 提供一個簡單、可信任的防災物資庫存管理工具，支援：

  * Items（品項）管理：分類/單位/最低庫存/備註
  * Transactions（入庫/消耗/盤點調整）
  * Stock View（庫存列表，手機與電腦皆可順暢使用）
  * 到期/低庫存 Email 提醒（排程作業 + 去重）
* 以交易/事件方式保留數量變動紀錄（入庫、消耗、盤點調整），便於追溯與回溯。

> 變更：庫存列表**不需要紀錄是否開封**。防災物資一旦開封通常很快會消耗掉，無需將「是否開封」納入欄位設計。

## 3. 非目標（Non-Goals）

* 不做完整 ERP / 複雜採購流程（供應商、報價、採購單、會計等）。
* 不做雲端硬碟或試算表的深度整合（例如 Google Drive/Sheets 雙向同步）作為 MVP 必備。
* 不追求完整離線 Web App（MVP 先以雲端使用為主；自架與純本地列後續功能）。

## 4. 目標使用者與使用情境（Who / When）

* 個人/家庭：日常維護防災物資（食物、飲水、醫療、工具等），定期盤點與補貨。
* 典型情境：

  * 平時：快速新增庫存、消耗、盤點調整
  * 定期：查看快到期與低庫存，安排補充
  * 緊急前：快速確認現有庫存是否達標

## 5. MVP 範圍（What’s in MVP）

> 原 PRD 中被移出 MVP 的項目，已完整保留到「8. 後續功能（Backlog）」；本節只保留第一版 MVP 必做。

### 5.1 帳號與資料隔離

* 帳號與登入：使用者可登入並建立資料（MVP 以 email magic link 或等價方案）。
* 多租戶隔離：所有資料以 `org_id`（或等價）綁定；RLS 覆蓋所有表。

### 5.2 倉庫（Warehouse）— MVP 簡化

* **MVP 每個使用者先只有一個倉庫**：

  * 不提供建立多倉庫 / 切換的 UI 與商業邏輯。
  * 但資料結構需能支援未來多倉庫。

### 5.3 存放點（Storage Locations）

* 倉庫層級維護一份「存放點清單/字典」，每個存放點包含 unique ID 與顯示名稱。
* 存放點可新增與改名（名稱更新反映於既有庫存顯示）。
* **存放點作廢屬於後續功能**（MVP 不提供作廢/禁用流程）。

### 5.4 類別標籤（Tags / Categories）

* 倉庫層級維護一份標籤字典。
* 標籤可新增與改名。
* **標籤作廢屬於後續功能**（MVP 不提供作廢/禁用流程）。

### 5.5 Items（品項）

* Items 作為「品項主檔」：

  * 欄位：品名、單位、最低庫存、類別標籤（可選）、備註（可選）
  * 可新增/編輯（品項主檔屬於管理資料，允許直接修改）。

### 5.6 庫存（Stock）與批次（Batch）

* 使用者可直接新增庫存（MVP **不做採購功能**，也不做採購→入庫轉換流程）。
* 庫存批次欄位（以批次為最小庫存粒度）：

  * 品項（Item）、數量
  * 到期日（可選）
  * 存放點（從倉庫存放點字典選擇；可選）
  * 類別標籤（可選；可與 Item 預設不同）
* 數量規則：

  * 入庫不允許小數
  * 消耗與盤點調整允許小數

### 5.7 Transactions（入庫 / 消耗 / 盤點調整）

* 入庫（新增庫存批次或增加既有批次的數量，依 feature 規格定義）。
* 消耗（出庫）：

  * 必須以交易/事件方式記錄並扣減庫存數量（允許小數）。
  * **MVP 不做「自動分配批次 + 覆寫」的複雜邏輯**；MVP 以「使用者手動選擇批次」為主。
* 盤點（調整）：

  * 以交易/事件方式記錄。
  * 必須要求使用者手動指定批次。
  * 盤點調整是「直接指定實際數量」；備註可選。
* 交易/事件紀錄不允許刪除；若填錯，使用者可用後續交易修正（等價於沖銷）。

### 5.8 Stock View（庫存列表）

* 初版 UI：**平攤所有批次**顯示（不聚合）。
* 支援基本搜尋（例如品名關鍵字）以快速找到項目。
* 手機優先設計，但 **在電腦上也必須可順利操作**（包含列表瀏覽、搜尋、入庫/消耗/盤點）。

### 5.9 到期 / 低庫存 Email 提醒（Jobs）

* 提醒通路：Email。
* 到期提醒：到期日為空（未填）者永不提醒。
* 低庫存提醒：當某品項（或等價聚合口徑）低於最低庫存時觸發。
* 需具備基本去重/頻率控制（避免 spam）。

## 6. 核心用例清單（Use Cases）

> 每個用例對應一份 feature 文件；PRD 只列用例，不寫細節。

* UC-01：使用者登入並建立/取得預設倉庫

  * Spec：docs/features/auth-and-onboarding.md
* UC-02：管理品項（Items）：新增/編輯（含最低庫存、單位、分類/標籤、備註）

  * Spec：docs/features/items.md
* UC-03：管理存放點字典：新增/改名

  * Spec：docs/features/storage-locations.md
* UC-04：管理標籤字典：新增/改名

  * Spec：docs/features/tags-and-categories.md
* UC-05：入庫：直接新增庫存批次或增加數量（產生交易紀錄）

  * Spec：docs/features/transactions-inbound.md
* UC-06：消耗（出庫）：手動選擇批次並扣減（產生交易紀錄）

  * Spec：docs/features/transactions-consumption.md
* UC-07：盤點（調整）：手動選擇批次並直接指定實際數量（產生交易紀錄）

  * Spec：docs/features/transactions-adjustment.md
* UC-08：查看庫存列表：平攤顯示所有批次 + 基本搜尋

  * Spec：docs/features/stock-view.md
* UC-09：到期/低庫存 Email 提醒：依規則寄送並去重

  * Spec：docs/features/notifications.md

## 7. 全局驗收（Definition of Done）

* 基本可用性

  * 使用者可登入並建立/取得預設倉庫，資料持久化於後端資料庫。
  * 在常見手機尺寸下完成入庫/消耗/盤點/查詢不需水平捲動，主要操作不被遮擋。
  * 在電腦瀏覽器下同樣可完成上述核心流程（不要求手機版同等 UI，但不得阻礙操作）。
* 品項與字典

  * 可新增/編輯 Items（含最低庫存、單位、類別/標籤、備註）。
  * 可新增/改名存放點；改名會反映於既有庫存顯示。
  * 可新增/改名標籤；改名會反映於既有紀錄顯示。
* 庫存與交易追溯（不可刪除）

  * 入庫/消耗/盤點調整皆會改變數量，且每次變動均有可追溯紀錄（交易/事件）。
  * 交易/事件紀錄不允許刪除；若填錯，使用者可用後續交易修正（等價沖銷）。
  * 數量規則符合：入庫不允許小數；消耗與盤點允許小數。
* 庫存列表

  * 庫存列表可平攤顯示所有批次，並可用基本搜尋快速找到項目。
* 通知

  * Email 到期提醒可選擇啟用並可觸發寄送，具備基本去重/頻率控制。
  * Email 低庫存提醒可選擇啟用並可觸發寄送，具備基本去重/頻率控制。
* 安全與資料隔離（高層次）

  * 資料以租戶/倉庫維度隔離，只有被授權的使用者能讀寫相對應資料（MVP 先以「單人單倉庫」授權模型實作，但資料模型需可擴充）。

## 8. 後續功能（Backlog — 保留細節，不過度化簡）

> 本節描述「在完成 MVP 的狀態上」後續功能應該長成什麼樣子（保留原本細節）。

### 8.1 多倉庫（Multi-warehouse）— 後續功能

* 使用者可建立多個倉庫並切換。
* 倉庫資料彼此隔離，UI 提供切換入口。

### 8.2 倉庫多人共享（Sharing）— 後續功能

* 可邀請其他使用者加入同一倉庫。
* 可將「團體（Group）」加入倉庫並賦予權限；團體內所有成員一體適用該權限。

### 8.3 角色/權限（Roles）— 後續功能

* 具備基本角色/權限控管（owner/editor/viewer）。
* 至少能區分「可編輯」與「只讀」行為；具體矩陣在 feature 定義。

### 8.4 團體（Group）— 後續功能

* 團體是一組使用者集合，對外視為單一成員。
* 團體至少有一名團體管理者；管理者可新增/移除成員並指派更多管理者。

### 8.5 存放點作廢（不可刪除）— 後續功能

* 存放點只能作廢、不能刪除；且若仍有庫存指向該存放點，則不可作廢。
* 被作廢的存放點不可再被新庫存選用，但需保留以供歷史追溯。

### 8.6 類別標籤作廢 — 後續功能

* 標籤字典以「倉庫」為範圍。
* 標籤可改名與作廢；紀錄應以標籤 ID 關聯，改名會反映到既有紀錄顯示。
* 作廢標籤：不可再被新物品選用；預設不可用於篩選；既有紀錄不強制更新，但顯示時加註「已作廢」。

### 8.7 採購功能（最優先的後續功能）

* 採購列表（待採購；支援交易紀錄）：

  * 物資欄位：品名、單項份量/包裝規格（可選）、數量（整數）、類別標籤。
  * 支援新增/編輯/（必要時）封存或移除（細節下放 feature）。
  * 採購→入庫屬於 transaction：採購列表需保留「轉出」紀錄以便追溯。

### 8.8 入庫轉換流程（採購→庫存；批次建立；部分入庫）— 後續功能

* 支援將採購項目轉為庫存項目（採購完成後的入庫主流程）。
* 允許「部分入庫」：入庫時需選擇本次入庫數量。
* 一次入庫建立的項目必定共享相同屬性（到期日/存放點/包裝規格等）；若要記錄不同包裝規格，需分開入庫。
* 入庫時可選填到期日、存放點，且允許更新標籤。
* 入庫時更新標籤僅影響「本次入庫生成的庫存項目（批次）」；不回寫採購項目或其他批次。
* 每次入庫操作套用的到期日與存放點需一致；若要輸入不同到期日/存放點，需分開多次入庫（形成多個批次）。

### 8.9 庫存編輯 — 後續功能

* 允許更正錯誤輸入（具體邊界下放 feature）。
* 交易仍不可刪除；修正需有一致策略（例如以後續交易/調整等價沖銷）。

### 8.10 兩層聚合顯示（UI / 紙本）— 後續功能（分階段）

實作順序：

1. **一開始 UI 先平攤所有項目顯示，不聚合。**（MVP）
2. 使用預設聚合方式聚合，無法設定。
3. 各物品各自指定聚合顯示方式。

   * 物品資料 migration：預設不聚合。

完整規格（原細節保留）：

* UI 與紙本皆採「兩層聚合顯示」：

  * 第一層：依品名聚合
  * 第二層：依（包裝規格、到期日、存放點）聚合
  * 使用者可設定需要哪些欄位一致才聚合，以及可省略哪些欄位不顯示（不顯示即不作為區分）
  * 同品名不同包裝規格預設分開；缺少包裝規格者也要與有包裝規格者分開
  * UI 的聚合/顯示設定與紙本輸出的設定可分開

### 8.11 紙本輸出（PDF / Print-friendly）— 後續功能

* 可列印的庫存清單（print-friendly / PDF）作為無網路/無電力時備援。
* 紙本上同一物品在第一層合併，並於第二層將不同批次分項列開（依使用者設定決定顯示/聚合欄位）。
* 紙本版面樣式作為獨立 feature 討論與驗收。

### 8.12 庫存轉移（存放點 ID 變更）— 後續功能

* 若要修改「物品實際放在哪個存放點（由存放點 ID 決定）」屬於交易（轉移/轉帳），應以新增一筆轉移紀錄處理（不可直接改 ID）。

### 8.13 物資篩選（進階總覽）— 後續功能

* 提供可篩選的總覽介面，協助快速盤點與找出「快到期 / 需替換補充」項目。
* 可依類別/關鍵字/存放點/到期狀態等條件篩選（具體條件下放 feature）。
* 顯示層支援依兩層聚合呈現與展開。

### 8.14 物資滿足單位（儲備規劃統計）— 後續功能

* 提供「滿足單位」機制以支援儲備規劃統計：

  * 使用者可自行定義單位種類與意涵
  * 並在物品批次上標註其可貢獻的單位量
* 可依「滿足單位」彙總統計（例如：乾糧總單位、飲水總單位）以協助儲備達標評估（MVP 先不做）。

### 8.15 庫存轉移/匯出與資料搬遷 — 後續功能

* 庫存/資料轉移（雲端 → 自架；雲端/自架 → 純本地；純本地 → 雲端/自架）：

  * 需定義可重建資料庫的匯出格式（建議包含 schema version、org/user 映射策略、交易/事件 replay 能力）。
  * 支援匯出/匯入資料庫實現資料轉移。

### 8.16 自架後端（grocy-like）— 後續功能

* 使用者可自行部署後端並連結前端。
* 支援從雲端環境匯出資料並搬遷到自架環境。

### 8.17 純本地（On-device）— 後續功能

* 使用者在電腦或手機上運行本地後端（前端無感）。
* 透過匯出/匯入資料庫實現資料轉移。
* 後端邏輯需能被搬移到使用者裝置上運行（或以等價方式重用同一套 domain）。

## 9. 仍待釐清（Questions to Confirm）

* （目前無）
