#!/usr/bin/env bash
set -euo pipefail

self_path="$(readlink -f "$0")"

# Prefer an already-installed host Supabase CLI (e.g. GitHub Action setup-cli)
# to avoid container image pulls in CI.
while IFS= read -r candidate; do
  [ -z "$candidate" ] && continue
  candidate_path="$(readlink -f "$candidate")"
  if [ "$candidate_path" != "$self_path" ]; then
    exec "$candidate" "$@"
  fi
done < <(type -a -p supabase | awk '!seen[$0]++')

if ! command -v docker >/dev/null 2>&1; then
  echo "[supabase wrapper] docker is required to run Supabase CLI when host supabase is unavailable." >&2
  echo "[supabase wrapper] Please install Docker Desktop / Docker Engine first." >&2
  exit 1
fi

IMAGE="public.ecr.aws/supabase/cli:latest"

exec docker run --rm \
  -v "${PWD}:${PWD}" \
  -w "${PWD}" \
  -v "${HOME}/.supabase:/root/.supabase" \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -e SUPABASE_ACCESS_TOKEN \
  -e SUPABASE_DB_PASSWORD \
  -e SUPABASE_PROJECT_ID \
  -e SUPABASE_ENV \
  "$IMAGE" "$@"
